sprint:
  name: "Demo Client Generator v3 - Patching Feature"
  start_date: "2025-01-23"
  end_date: null
  status: "in_progress"

epics:
  - id: "E1"
    name: "Demo Tenant Patch System"
    status: "completed"
    stories:
      - id: "E1-S1"
        name: "Implement additive patch mode"
        status: "completed"
        completed_at: "2025-01-23"
      - id: "E1-S2"
        name: "Monthly Updates UI (TARGETS mode)"
        status: "completed"
        completed_at: "2025-01-23"

  - id: "E2"
    name: "RECONCILE Mode Implementation"
    status: "completed"
    stories:
      - id: "E2-S1"
        name: "Implement RECONCILE mode in patch engine"
        status: "completed"
        completed_at: "2025-01-25"
        notes: |
          - Added executeReconcileDeletions() method
          - FK-safe deletion order: activities → deals → contacts → companies
          - NOT EXISTS guards for referential integrity
          - Only deletes demoGenerated=true records
      - id: "E2-S2"
        name: "Update patch validator for reconcile mode"
        status: "completed"
        completed_at: "2025-01-25"
        notes: |
          - Allow negative deltas in reconcile mode
          - Updated preview to show records to delete
      - id: "E2-S3"
        name: "Add mode selector UI"
        status: "completed"
        completed_at: "2025-01-25"
        notes: |
          - Visual toggle between additive/reconcile
          - Warning banner for reconcile mode
          - Red highlighting for decreasing values

  - id: "E3"
    name: "METRICS-ONLY Mode Enhancement"
    status: "completed"
    stories:
      - id: "E3-S1"
        name: "Expand metrics-only mode to support all 6 metrics"
        status: "completed"
        completed_at: "2025-01-28"
        notes: |
          Implementation (BMAD workflow):
          - Added 4 new columns to demoMetricOverrides table
          - contactsCreatedOverride, companiesCreatedOverride, dealsCreatedOverride, activitiesCreatedOverride
          - Updated frontend to enable all metrics in metrics-only mode
          - Updated validation endpoint with business logic rules
          - Updated apply endpoint to store all 6 override types
          - Updated reports and dashboard APIs to apply all overrides

          Code review fixes:
          - Fixed decimal truncation: closedWonValue now uses parseFloat (was parseInt)
          - Added step="0.01" for currency input fields
          - Updated UI text to reflect all metrics can be edited
          - Added validation: closedWonCount cannot exceed dealsCreated
          - Added validation: closedWonValue requires closedWonCount > 0

          Migration: 0004_metrics_only_all_fields.sql

blockers: []

risks:
  - description: "Accidental data loss if reconcile mode misused"
    mitigation: "Only deletes demo-generated records; clear UI warning"
    status: "mitigated"

notes: |
  METRICS-ONLY mode expanded to support ALL 6 metrics (2025-01-28):
  - Users can now adjust: contacts, companies, deals, won deals, won value, activities
  - Changes are stored as report adjustments without creating actual records
  - Ideal for quickly adjusting dashboard and report numbers for demos

  RECONCILE mode feature complete and deployed (2025-01-25).

  Bug fixes (commit 857916b):
  - CRITICAL: Fixed UTC timezone mismatch in patch-engine date ranges
  - KPI aggregator used Date.UTC(), patch engine used local time
  - This caused deletion queries to find no records (wrong date range)
  - Added date range logging for debugging
  - Optimized executePatch to skip months with no positive deltas

  Previous fixes (commits a2425b6, 22c2340):
  - Fixed json/jsonb concatenation: (logs::jsonb || value::jsonb)::json
  - Added fallback for records without demoSourceMonth field
  - Changed from async fire-and-forget to synchronous execution
  - Added maxDuration=300 for Vercel long-running functions

  Key features:
  - Users can now decrease metric values in demo tenants
  - Deletions only affect demo-generated records (demoGenerated=true)
  - Records filtered by demoSourceMonth OR createdAt date range
  - FK-safe deletion order prevents referential integrity issues
  - Clear UI indication and warning for destructive operations
