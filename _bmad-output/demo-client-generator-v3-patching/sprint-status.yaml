sprint:
  name: "Demo Client Generator v3 - Patching Feature"
  start_date: "2025-01-23"
  end_date: null
  status: "in_progress"

epics:
  - id: "E1"
    name: "Demo Tenant Patch System"
    status: "completed"
    stories:
      - id: "E1-S1"
        name: "Implement additive patch mode"
        status: "completed"
        completed_at: "2025-01-23"
      - id: "E1-S2"
        name: "Monthly Updates UI (TARGETS mode)"
        status: "completed"
        completed_at: "2025-01-23"

  - id: "E2"
    name: "RECONCILE Mode Implementation"
    status: "completed"
    stories:
      - id: "E2-S1"
        name: "Implement RECONCILE mode in patch engine"
        status: "completed"
        completed_at: "2025-01-25"
        notes: |
          - Added executeReconcileDeletions() method
          - FK-safe deletion order: activities → deals → contacts → companies
          - NOT EXISTS guards for referential integrity
          - Only deletes demoGenerated=true records
      - id: "E2-S2"
        name: "Update patch validator for reconcile mode"
        status: "completed"
        completed_at: "2025-01-25"
        notes: |
          - Allow negative deltas in reconcile mode
          - Updated preview to show records to delete
      - id: "E2-S3"
        name: "Add mode selector UI"
        status: "completed"
        completed_at: "2025-01-25"
        notes: |
          - Visual toggle between additive/reconcile
          - Warning banner for reconcile mode
          - Red highlighting for decreasing values

blockers: []

risks:
  - description: "Accidental data loss if reconcile mode misused"
    mitigation: "Only deletes demo-generated records; clear UI warning"
    status: "mitigated"

notes: |
  RECONCILE mode feature complete and deployed.

  Bug fixes (commit 857916b):
  - CRITICAL: Fixed UTC timezone mismatch in patch-engine date ranges
  - KPI aggregator used Date.UTC(), patch engine used local time
  - This caused deletion queries to find no records (wrong date range)
  - Added date range logging for debugging
  - Optimized executePatch to skip months with no positive deltas

  Previous fixes (commits a2425b6, 22c2340):
  - Fixed json/jsonb concatenation: (logs::jsonb || value::jsonb)::json
  - Added fallback for records without demoSourceMonth field
  - Changed from async fire-and-forget to synchronous execution
  - Added maxDuration=300 for Vercel long-running functions

  Key features:
  - Users can now decrease metric values in demo tenants
  - Deletions only affect demo-generated records (demoGenerated=true)
  - Records filtered by demoSourceMonth OR createdAt date range
  - FK-safe deletion order prevents referential integrity issues
  - Clear UI indication and warning for destructive operations
